name: ci

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:
  push:
    branches:
      - master
    tags-ignore:
      - "*"

jobs:
  build:
    if: false
    concurrency:
      group: "${{ github.workflow }}-${{ github.ref }}"
      cancel-in-progress: true
    uses: ./.github/workflows/_build_wheels.yaml

  cargo-fmt:
    if: false
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt,clippy
      - run: cargo fmt --check --all
      - run: cargo clippy

  test:
    if: false
    strategy:
      matrix:
        os: ["ubuntu-24.04", "macos-13", "macos-14", "windows-latest"]
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    runs-on: "${{ matrix.os }}"

    needs: [build]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4.1.8
        with:
          name: wheel
          path: dist

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip" # caching pip dependencies

      - run: python -m pip install -U pip
      - run: pip install bencode-rs --no-index --find-link ./dist/
      - run: pip install -r requirements.txt

      - run: pytest -sv
        env:
          RUST_BACKTRACE: 'full'

  pgo-wheel:
    runs-on: "ubuntu-24.04"
    env:
      PY: '3.10'
      RUST_CHANNEL: '1.83'
    steps:
      - uses: actions/checkout@v4

      - name: prepare profiling directory
        shell: bash
        run: mkdir -p ${{ github.workspace }}/profdata

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: '${{ env.PY }}'
          cache: "pip"

      - name: build initial wheel
        uses: PyO3/maturin-action@v1
        with:
          manylinux: auto
          args: >
            --release
            --out pgo-wheel
            --interpreter '${{ env.PY }}'
          docker-options: -e CI
          rust-toolchain: '${{ env.RUST_CHANNEL }}'
        env:
          RUSTFLAGS: '-Cprofile-generate=${{ github.workspace }}/profdata'

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: '${{ env.RUST_CHANNEL }}'
          components: llvm-tools-preview

      - run: |
          echo RUST_HOST=$(rustc -Vv | grep host | cut -d ' ' -f 2) >> "$GITHUB_ENV"

      - name: detect rust host
        run: |
          rustup run '${{ env.RUST_CHANNEL }}' bash -c 'echo LLVM_PROFDATA=$RUSTUP_HOME/toolchains/$RUSTUP_TOOLCHAIN/lib/rustlib/${{ env.RUST_HOST }}/bin/llvm-profdata >> "$GITHUB_ENV"'
        shell: bash

      - name: generate pgo data
        run: |
          pip install pytest pytest-benchmark
          pip install bencode-rs --no-index --find-link pgo-wheel/
          pytest tests/bench.py --benchmark-min-time=0.3
        shell: bash

      - name: merge pgo data
        run: ${{ env.LLVM_PROFDATA }} merge -o ${{ github.workspace }}/merged.profdata ${{ github.workspace }}/profdata
        shell: bash

      - name: build pgo-optimized wheel
        uses: PyO3/maturin-action@v1
        with:
          manylinux: auto
          args: >
            --release
            --out dist
            --interpreter '${{ env.PY }}'
          docker-options: -e CI
          rust-toolchain: '${{ env.RUST_CHANNEL }}'
        env:
          RUSTFLAGS: '-Cprofile-use=${{ github.workspace }}/merged.profdata'


      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: pgo-${{ runner.os }}
          path: dist

  bench-cp:
    needs: [pgo-wheel]

    strategy:
      matrix:
        python-version:
          - "3.10"

    runs-on: "ubuntu-24.04"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4.1.8
        with:
          pattern: 'pgo-*'
          merge-multiple: true
          path: dist

      - run: tree dist

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - run: pip install bencode-rs --no-index --find-links ./dist/
      - run: pip install -r requirements.txt

      - name: Run benchmarks
        uses: CodSpeedHQ/action@v3
        with:
          token: ${{ secrets.CODSPEED_TOKEN }}
          run: python -m pytest tests/bench.py --codspeed

  audit:
    name: Audit
    if: false
    needs: [build]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip" # caching pip dependencies

      - run: pip install -r requirements.txt

      - uses: actions/download-artifact@v4
        with:
          name: wheel
          path: dist

      - run: abi3audit --verbose dist/*.whl
      - run: pipx run twine check --strict dist/*


  coverage:
    if: false
    name: Coverage for ${{ matrix.python-version }}
    strategy:
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "${{ matrix.python-version }}"
          cache: "pip"

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: llvm-tools

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - run: pip install -r requirements.txt

      - name: Run coverage
        run: |
          set -euxo pipefail
          source <(cargo llvm-cov show-env --export-prefix)
          export CARGO_TARGET_DIR=$CARGO_LLVM_COV_TARGET_DIR
          cargo llvm-cov clean --workspace
          cargo build
          ls target/debug -ahl
          cp target/debug/libbencode.so py/bencode_rs/_bencode.so
          PYTHONPATH=py pytest tests
          cargo llvm-cov report --lcov --output-path coverage.lcov

      - uses: codecov/codecov-action@v5
        with:
          files: coverage.lcov
          token: '${{ secrets.CODECOV_TOKEN }}'
